<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivesta Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .auth-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-success {
            background: #10b981;
            color: white;
        }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .section {
            margin-bottom: 30px;
        }
        .section-title {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        .result pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .user-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .user-card h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 10px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
        }
        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 12px;
        }
        .info-value {
            color: #333;
            margin-top: 2px;
        }
        .error {
            background: #fee;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .success {
            background: #efe;
            color: #060;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê Trivesta Admin Panel</h1>
        <p class="subtitle">Manage users and investments</p>

        <!-- Authentication -->
        <div class="auth-section">
            <div class="input-group">
                <label>Admin Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button class="btn btn-primary" onclick="testPassword()" style="margin-top: 10px;">Test Password</button>
            <div id="passwordTestResult" style="margin-top: 10px;"></div>
            <small style="color: #666; display: block; margin-top: 10px;">Default: trivesta2025admin (Change in backend .env file: ADMIN_PASSWORD)</small>
        </div>

        <!-- Get All Users -->
        <div class="section">
            <h2 class="section-title">üìã All Users</h2>
            <button class="btn btn-primary" onclick="getAllUsers()">Get All Users</button>
            <div id="usersResult" class="result" style="display: none;"></div>
        </div>

        <!-- Get User Details -->
        <div class="section">
            <h2 class="section-title">üîç User Details</h2>
            <div class="input-group">
                <label>User Email:</label>
                <input type="email" id="userEmail" placeholder="user@example.com">
            </div>
            <button class="btn btn-primary" onclick="getUserDetails()">Get User Details</button>
            <div id="userDetailsResult" class="result" style="display: none;"></div>
        </div>

        <!-- Create Investment Manually -->
        <div class="section">
            <h2 class="section-title">üí∞ Create Investment Manually</h2>
            <div class="input-group">
                <label>User Email:</label>
                <input type="email" id="investEmail" placeholder="user@example.com">
            </div>
            <div class="input-group">
                <label>Plan:</label>
                <select id="investPlan">
                    <option value="basic">Basic (30 days)</option>
                    <option value="premium">Premium (90 days)</option>
                    <option value="exclusive">Exclusive (180 days)</option>
                    <option value="presale">Presale (365 days)</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="input-group">
                <label>Amount ($):</label>
                <input type="number" id="investAmount" placeholder="100">
            </div>
            <div class="input-group">
                <label>Cryptocurrency:</label>
                <select id="investCrypto">
                    <option value="USDT">USDT</option>
                    <option value="ETH">ETH</option>
                    <option value="BTC">BTC</option>
                    <option value="SOL">SOL</option>
                </select>
            </div>
            <div class="input-group">
                <label>Transaction Hash:</label>
                <input type="text" id="investTxHash" placeholder="0x...">
            </div>
            <div class="input-group">
                <label>Duration (days):</label>
                <input type="number" id="investDuration" placeholder="30">
            </div>
            <button class="btn btn-success" onclick="createInvestment()">Create Investment (Skip Verification)</button>
            <div id="investResult" class="result" style="display: none;"></div>
        </div>

        <!-- Update Investment Duration -->
        <div class="section">
            <h2 class="section-title">‚è±Ô∏è Update Investment Duration</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                Change how long a user's investment is locked. For example, change from 30 days to 14 days.
            </p>
            <div class="input-group">
                <label>User Email:</label>
                <input type="email" id="updateDurationEmail" placeholder="user@example.com">
            </div>
            <div class="input-group">
                <label>New Duration (days):</label>
                <input type="number" id="updateDurationDays" placeholder="14" min="1">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Enter the number of days (e.g., 14 for 14 days, 30 for 30 days)
                </small>
            </div>
            <div class="input-group">
                <label>Investment ID (Optional):</label>
                <input type="text" id="updateDurationInvestmentId" placeholder="Leave empty to update ALL investments">
                <small style="color: #666; display: block; margin-top: 5px;">
                    If you leave this empty, it will update ALL investments for this user. 
                    If you enter an ID, it will only update that specific investment.
                </small>
            </div>
            <button class="btn btn-warning" onclick="updateInvestmentDuration()">Update Duration</button>
            <div id="updateDurationResult" class="result" style="display: none;"></div>
        </div>

        <!-- Update User Gas Fee -->
        <div class="section">
            <h2 class="section-title">‚õΩ Update User Gas Fee</h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
                Set the gas fee amount required for withdrawal for a specific user.
            </p>
            <div class="input-group">
                <label>User Email:</label>
                <input type="email" id="updateGasFeeEmail" placeholder="user@example.com">
            </div>
            <div class="input-group">
                <label>Gas Fee Amount ($):</label>
                <input type="number" id="updateGasFeeAmount" placeholder="2500" min="0" step="0.01">
                <small style="color: #666; display: block; margin-top: 5px;">
                    Enter the gas fee amount in USD (e.g., 2500 for $2500)
                </small>
            </div>
            <button class="btn btn-warning" onclick="updateGasFee()">Update Gas Fee</button>
            <div id="updateGasFeeResult" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Automatically detect the API URL based on current location
        const API_URL = window.location.origin + '/api/admin';
        
        console.log('Admin Panel API URL:', API_URL);

        function getHeaders() {
            return {
                'Content-Type': 'application/json',
                'x-admin-password': document.getElementById('adminPassword').value
            };
        }

        async function testPassword() {
            const password = document.getElementById('adminPassword').value;
            const resultDiv = document.getElementById('passwordTestResult');
            
            if (!password) {
                resultDiv.innerHTML = '<div class="error">Please enter a password first</div>';
                return;
            }

            resultDiv.innerHTML = '<p>Testing password...</p>';

            try {
                const response = await fetch(`${API_URL}/test-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-admin-password': password
                    },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (data.match) {
                    resultDiv.innerHTML = '<div class="success">‚úì Password is correct! You can now use the admin features.</div>';
                } else {
                    let html = `
                        <div class="error">
                            ‚úó Password does not match!<br><br>
                            <strong>Length Info:</strong><br>
                            Expected (trimmed): ${data.expectedLength} characters<br>
                            Your password (trimmed): ${data.providedLength} characters<br>
                            Original expected length: ${data.originalExpectedLength} characters<br>
                            Original your length: ${data.originalProvidedLength} characters<br><br>
                            <strong>Character Matching:</strong><br>
                            First character matches: ${data.firstCharMatch ? 'Yes' : 'No'}<br>
                            First 3 characters match: ${data.first3CharsMatch ? 'Yes' : 'No'}<br><br>
                    `;
                    
                    if (data.hasWhitespaceIssue) {
                        html += `<strong style="color: #f59e0b;">‚ö†Ô∏è WHITESPACE DETECTED!</strong><br>
                            Your .env file likely has extra spaces or newlines.<br>
                            Make sure your .env line looks exactly like this (no spaces around =):<br>
                            <code style="background: #f0f0f0; padding: 5px; display: block; margin-top: 5px;">ADMIN_PASSWORD=yourpassword</code><br><br>`;
                    }
                    
                    html += `<small>Check your backend/.env file for extra spaces, newlines, or special characters</small>
                        </div>`;
                    
                    resultDiv.innerHTML = html;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function getAllUsers() {
            const resultDiv = document.getElementById('usersResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Loading...</p>';

            try {
                const response = await fetch(`${API_URL}/users`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch users');
                }

                let html = `<h3>Total Users: ${data.total}</h3>`;
                data.users.forEach(user => {
                    html += `
                        <div class="user-card">
                            <h3>${user.name || 'No Name'}</h3>
                            <div class="user-info">
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${user.email}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">User ID</div>
                                    <div class="info-value">${user.id}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Referral Code</div>
                                    <div class="info-value">${user.referralCode}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Investments</div>
                                    <div class="info-value">${user.investmentCount}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Joined</div>
                                    <div class="info-value">${new Date(user.createdAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function getUserDetails() {
            const email = document.getElementById('userEmail').value;
            const resultDiv = document.getElementById('userDetailsResult');
            
            if (!email) {
                alert('Please enter user email');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Loading...</p>';

            try {
                const response = await fetch(`${API_URL}/user/${encodeURIComponent(email)}`, {
                    headers: getHeaders()
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch user');
                }

                let html = `
                    <div class="user-card">
                        <h3>${data.user.name || 'No Name'}</h3>
                        <div class="user-info">
                            <div class="info-item">
                                <div class="info-label">Email</div>
                                <div class="info-value">${data.user.email}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">User ID</div>
                                <div class="info-value">${data.user.id}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Referral Code</div>
                                <div class="info-value">${data.user.referralCode}</div>
                            </div>
                        </div>
                    </div>
                    <h3 style="margin-top: 20px;">Investments (${data.investments.length})</h3>
                `;

                if (data.investments.length === 0) {
                    html += '<p>No investments yet</p>';
                } else {
                    data.investments.forEach(inv => {
                        html += `
                            <div class="user-card">
                                <div class="user-info">
                                    <div class="info-item">
                                        <div class="info-label">Plan</div>
                                        <div class="info-value">${inv.plan}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Amount</div>
                                        <div class="info-value">$${inv.amount}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Crypto</div>
                                        <div class="info-value">${inv.crypto}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">TVS Locked</div>
                                        <div class="info-value">${inv.tvsLocked} TVS</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Status</div>
                                        <div class="info-value">${inv.status}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Duration</div>
                                        <div class="info-value">${inv.duration} days</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">TX Hash</div>
                                        <div class="info-value" style="font-size: 10px; word-break: break-all;">${inv.txHash}</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Created</div>
                                        <div class="info-value">${new Date(inv.createdAt).toLocaleString()}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function createInvestment() {
            const email = document.getElementById('investEmail').value;
            const plan = document.getElementById('investPlan').value;
            const amount = document.getElementById('investAmount').value;
            const crypto = document.getElementById('investCrypto').value;
            const txHash = document.getElementById('investTxHash').value;
            const duration = document.getElementById('investDuration').value;
            const resultDiv = document.getElementById('investResult');

            if (!email || !plan || !amount || !crypto || !txHash) {
                alert('Please fill all fields');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Creating investment...</p>';

            try {
                const response = await fetch(`${API_URL}/investment/create`, {
                    method: 'POST',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        email,
                        plan,
                        amount: parseFloat(amount),
                        crypto,
                        txHash,
                        duration: duration ? parseInt(duration) : undefined
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'Failed to create investment');
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úì Investment Created Successfully!</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                // Clear form
                document.getElementById('investEmail').value = '';
                document.getElementById('investAmount').value = '';
                document.getElementById('investTxHash').value = '';
                document.getElementById('investDuration').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function updateInvestmentDuration() {
            const email = document.getElementById('updateDurationEmail').value;
            const duration = document.getElementById('updateDurationDays').value;
            const investmentId = document.getElementById('updateDurationInvestmentId').value;
            const resultDiv = document.getElementById('updateDurationResult');

            if (!email || !duration) {
                alert('Please enter user email and duration');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Updating investment duration...</p>';

            try {
                const body = {
                    duration: parseFloat(duration)
                };
                
                // Add investment ID if provided
                if (investmentId && investmentId.trim() !== '') {
                    body.investmentId = investmentId.trim();
                }

                const response = await fetch(`${API_URL}/user/${encodeURIComponent(email)}/investment/duration`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'Failed to update duration');
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úì Duration Updated Successfully!</h3>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <pre style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto;">${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;

                // Clear form
                document.getElementById('updateDurationDays').value = '';
                document.getElementById('updateDurationInvestmentId').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function updateGasFee() {
            const email = document.getElementById('updateGasFeeEmail').value;
            const gasFee = document.getElementById('updateGasFeeAmount').value;
            const resultDiv = document.getElementById('updateGasFeeResult');

            if (!email || !gasFee) {
                alert('Please enter user email and gas fee amount');
                return;
            }

            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<p>Updating gas fee...</p>';

            try {
                const response = await fetch(`${API_URL}/user/${encodeURIComponent(email)}/gas-fee`, {
                    method: 'PUT',
                    headers: getHeaders(),
                    body: JSON.stringify({
                        gasFee: parseFloat(gasFee)
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || data.details || 'Failed to update gas fee');
                }

                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úì Gas Fee Updated Successfully!</h3>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <p><strong>User:</strong> ${data.user.email}</p>
                        <p><strong>Gas Fee:</strong> $${data.user.gasFee.toLocaleString()}</p>
                    </div>
                `;

                // Clear form
                document.getElementById('updateGasFeeAmount').value = '';
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>

